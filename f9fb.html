<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/cn/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/cn/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/cn/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/cn/images/logo.svg" color="#222">

<link rel="stylesheet" href="/cn/css/main.css">



<link rel="stylesheet" href="/cn/css/all.min.css">
  <link rel="stylesheet" href="/cn/css/animate.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"mapan.tech","root":"/cn/","images":"/cn/images","scheme":"Mist","darkmode":false,"version":"8.10.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/cn/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/cn/js/config.js"></script>

  <meta name="description" content="我有早起的习惯，每天早晨上班前的这段时间脑子非常清醒，这段时间我会用来充实自己。看到某个公众号发了一篇Hive的面试题的推文，顺手拿过来做了下。共计10道题，花了下班后的晚上和一个早晨的时间写完。 第一题需求： 1234567891011121314151617我们有如下的用户访问数据    userId  visitDate   visitCount    u01 2017&#x2F;1&#x2F;21   5">
<meta property="og:type" content="article">
<meta property="og:title" content="10道经典Hive题目">
<meta property="og:url" content="https://mapan.tech/cn/f9fb.html">
<meta property="og:site_name" content="马攀的个人站">
<meta property="og:description" content="我有早起的习惯，每天早晨上班前的这段时间脑子非常清醒，这段时间我会用来充实自己。看到某个公众号发了一篇Hive的面试题的推文，顺手拿过来做了下。共计10道题，花了下班后的晚上和一个早晨的时间写完。 第一题需求： 1234567891011121314151617我们有如下的用户访问数据    userId  visitDate   visitCount    u01 2017&#x2F;1&#x2F;21   5">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-05-13T23:14:30.000Z">
<meta property="article:modified_time" content="2020-05-21T12:05:11.149Z">
<meta property="article:author" content="Pan">
<meta property="article:tag" content="大数据,BigData,数据开发,Hadoop,Spark,Flink,Hive,HBase">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://mapan.tech/cn/f9fb.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://mapan.tech/cn/f9fb.html","path":"f9fb.html","title":"10道经典Hive题目"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>10道经典Hive题目 | 马攀的个人站</title>
  




<link rel="dns-prefetch" href="https://comment.mapan.tech">
  <noscript>
    <link rel="stylesheet" href="/cn/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/cn/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">马攀的个人站</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/cn/index.html" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/cn/about.html" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-categories"><a href="/cn/categories.html" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-message"><a href="/cn/message.html" rel="section"><i class="fas fa-comment fa-fw"></i>留言</a></li>
        <li class="menu-item menu-item-links"><a href="/cn/links.html" rel="section"><i class="fab fa-grav fa-fw"></i>友链</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%A2%98"><span class="nav-number">1.</span> <span class="nav-text">第一题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%A2%98"><span class="nav-number">1.1.</span> <span class="nav-text">第二题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%A2%98"><span class="nav-number">1.2.</span> <span class="nav-text">第三题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%A2%98"><span class="nav-number">1.3.</span> <span class="nav-text">第四题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E9%A2%98"><span class="nav-number">1.4.</span> <span class="nav-text">第五题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E9%A2%98"><span class="nav-number">1.5.</span> <span class="nav-text">第六题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%83%E9%A2%98"><span class="nav-number">1.6.</span> <span class="nav-text">第七题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AB%E9%A2%98"><span class="nav-number">1.7.</span> <span class="nav-text">第八题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B9%9D%E9%A2%98"><span class="nav-number">1.8.</span> <span class="nav-text">第九题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%8D%81%E9%A2%98%EF%BC%9A"><span class="nav-number">1.9.</span> <span class="nav-text">第十题：</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Pan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-categories">
          <a href="/cn/categories.html">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://mapan.tech/cn/f9fb.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/cn/images/avatar.gif">
      <meta itemprop="name" content="Pan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="马攀的个人站">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          10道经典Hive题目
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-14 07:14:30" itemprop="dateCreated datePublished" datetime="2020-05-14T07:14:30+08:00">2020-05-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2020-05-21 20:05:11" itemprop="dateModified" datetime="2020-05-21T20:05:11+08:00">2020-05-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/cn/categories/Hive/" itemprop="url" rel="index"><span itemprop="name">Hive</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/cn/f9fb.html#waline-comments" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" id="/cn/f9fb.html" data-xid="/cn/f9fb.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span id="/cn/f9fb.html" class="post-meta-item leancloud_visitors" data-flag-title="10道经典Hive题目" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>我有早起的习惯，每天早晨上班前的这段时间脑子非常清醒，这段时间我会用来充实自己。看到某个公众号发了一篇Hive的面试题的推文，顺手拿过来做了下。共计10道题，花了下班后的晚上和一个早晨的时间写完。</p>
<h1 id="第一题"><a href="#第一题" class="headerlink" title="第一题"></a>第一题</h1><p>需求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">我们有如下的用户访问数据</span><br><span class="line">    userId  visitDate   visitCount</span><br><span class="line">    u01 2017/1/21   5</span><br><span class="line">    u02 2017/1/23   6</span><br><span class="line">    u03 2017/1/22   8</span><br><span class="line">    u04 2017/1/20   3</span><br><span class="line">    u01 2017/1/23   6</span><br><span class="line">    u01 2017/2/21   8</span><br><span class="line">    U02 2017/1/23   6</span><br><span class="line">    U01 2017/2/22   4</span><br><span class="line">要求使用SQL统计出每个用户的累积访问次数，如下表所示：</span><br><span class="line">    用户id    月份  小计  累积</span><br><span class="line">    u01 2017-01 11  11</span><br><span class="line">    u01 2017-02 12  23</span><br><span class="line">    u02 2017-01 12  12</span><br><span class="line">    u03 2017-01 8   8</span><br><span class="line">    u04 2017-01 3   3</span><br></pre></td></tr></table></figure>
<p>实现：<br>数据准备：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test1 ( </span><br><span class="line">        userId string, </span><br><span class="line">        visitDate string,</span><br><span class="line">        visitCount <span class="type">INT</span> )</span><br><span class="line">    <span class="type">ROW</span> format delimited FIELDS TERMINATED <span class="keyword">BY</span> &quot;\t&quot;;</span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test1</span><br><span class="line">    <span class="keyword">VALUES</span></span><br><span class="line">        ( <span class="string">&#x27;u01&#x27;</span>, <span class="string">&#x27;2017/1/21&#x27;</span>, <span class="number">5</span> ),</span><br><span class="line">        ( <span class="string">&#x27;u02&#x27;</span>, <span class="string">&#x27;2017/1/23&#x27;</span>, <span class="number">6</span> ),</span><br><span class="line">        ( <span class="string">&#x27;u03&#x27;</span>, <span class="string">&#x27;2017/1/22&#x27;</span>, <span class="number">8</span> ),</span><br><span class="line">        ( <span class="string">&#x27;u04&#x27;</span>, <span class="string">&#x27;2017/1/20&#x27;</span>, <span class="number">3</span> ),</span><br><span class="line">        ( <span class="string">&#x27;u01&#x27;</span>, <span class="string">&#x27;2017/1/23&#x27;</span>, <span class="number">6</span> ),</span><br><span class="line">        ( <span class="string">&#x27;u01&#x27;</span>, <span class="string">&#x27;2017/2/21&#x27;</span>, <span class="number">8</span> ),</span><br><span class="line">        ( <span class="string">&#x27;u02&#x27;</span>, <span class="string">&#x27;2017/1/23&#x27;</span>, <span class="number">6</span> ),</span><br><span class="line">        ( <span class="string">&#x27;u01&#x27;</span>, <span class="string">&#x27;2017/2/22&#x27;</span>, <span class="number">4</span> );</span><br></pre></td></tr></table></figure>
<p>查询SQL：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">with t1 as(</span><br><span class="line">    select</span><br><span class="line">        userid,</span><br><span class="line">        date_format(regexp_replace(visitdate,&#x27;/&#x27;,&#x27;-&#x27;),&#x27;YYYY-MM&#x27;) as vdate,</span><br><span class="line">        sum(visitcount) as vcount</span><br><span class="line">    from prac.test1</span><br><span class="line">    group by userid,date_format(regexp_replace(visitdate,&#x27;/&#x27;,&#x27;-&#x27;),&#x27;YYYY-MM&#x27;)</span><br><span class="line">)</span><br><span class="line">select</span><br><span class="line">    userid,</span><br><span class="line">    vdate,</span><br><span class="line">    vcount,</span><br><span class="line">    sum(vcount) over (partition by userid order by vdate)</span><br><span class="line">from t1;</span><br></pre></td></tr></table></figure>
<h2 id="第二题"><a href="#第二题" class="headerlink" title="第二题"></a>第二题</h2><p>需求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">有50W个京东店铺，每个顾客访客访问任何一个店铺的任何一个商品时都会产生一条访问日志，</span><br><span class="line">访问日志存储的表名为Visit，访客的用户id为user_id，被访问的店铺名称为shop，数据如下：</span><br><span class="line"></span><br><span class="line">                u1  a</span><br><span class="line">                u2  b</span><br><span class="line">                u1  b</span><br><span class="line">                u1  a</span><br><span class="line">                u3  c</span><br><span class="line">                u4  b</span><br><span class="line">                u1  a</span><br><span class="line">                u2  c</span><br><span class="line">                u5  b</span><br><span class="line">                u4  b</span><br><span class="line">                u6  c</span><br><span class="line">                u2  c</span><br><span class="line">                u1  b</span><br><span class="line">                u2  a</span><br><span class="line">                u2  a</span><br><span class="line">                u3  a</span><br><span class="line">                u5  a</span><br><span class="line">                u5  a</span><br><span class="line">                u5  a</span><br><span class="line">请统计：</span><br><span class="line">(1)每个店铺的UV（访客数）</span><br><span class="line">(2)每个店铺访问次数top3的访客信息。输出店铺名称、访客id、访问次数</span><br></pre></td></tr></table></figure>
<p>数据准备：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test2 ( </span><br><span class="line">    user_id string, </span><br><span class="line">    shop string </span><br><span class="line">)</span><br><span class="line"><span class="type">ROW</span> format delimited FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>; </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test2 <span class="keyword">VALUES</span></span><br><span class="line">( <span class="string">&#x27;u1&#x27;</span>, <span class="string">&#x27;a&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u2&#x27;</span>, <span class="string">&#x27;b&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u1&#x27;</span>, <span class="string">&#x27;b&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u1&#x27;</span>, <span class="string">&#x27;a&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u3&#x27;</span>, <span class="string">&#x27;c&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u4&#x27;</span>, <span class="string">&#x27;b&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u1&#x27;</span>, <span class="string">&#x27;a&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u2&#x27;</span>, <span class="string">&#x27;c&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u5&#x27;</span>, <span class="string">&#x27;b&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u4&#x27;</span>, <span class="string">&#x27;b&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u6&#x27;</span>, <span class="string">&#x27;c&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u2&#x27;</span>, <span class="string">&#x27;c&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u1&#x27;</span>, <span class="string">&#x27;b&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u2&#x27;</span>, <span class="string">&#x27;a&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u2&#x27;</span>, <span class="string">&#x27;a&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u3&#x27;</span>, <span class="string">&#x27;a&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u5&#x27;</span>, <span class="string">&#x27;a&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u5&#x27;</span>, <span class="string">&#x27;a&#x27;</span> ),</span><br><span class="line">( <span class="string">&#x27;u5&#x27;</span>, <span class="string">&#x27;a&#x27;</span> ); </span><br></pre></td></tr></table></figure>

<p>查询SQL：<br>(1)每个店铺的UV（访客数）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    shop,</span><br><span class="line">    <span class="built_in">count</span>(<span class="keyword">distinct</span> user_id) <span class="keyword">as</span> user_cnt</span><br><span class="line"><span class="keyword">from</span> prac.test2</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> shop;</span><br></pre></td></tr></table></figure>
<p>(2)每个店铺访问次数top3的访客信息。输出店铺名称、访客id、访问次数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        shop,</span><br><span class="line">        user_id,</span><br><span class="line">        <span class="built_in">count</span>(user_id) <span class="keyword">as</span> cnt</span><br><span class="line">    <span class="keyword">from</span> prac.test2</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> shop,user_id</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        shop,</span><br><span class="line">        user_id,</span><br><span class="line">        cnt,</span><br><span class="line">        <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> shop <span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span>) <span class="keyword">as</span> rk</span><br><span class="line">    <span class="keyword">from</span> t1</span><br><span class="line">) <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">where</span> rk<span class="operator">&lt;=</span><span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<h2 id="第三题"><a href="#第三题" class="headerlink" title="第三题"></a>第三题</h2><p>需求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">已知一个表STG.ORDER，有如下字段:Date，Order_id，User_id，amount。</span><br><span class="line">数据样例:2017-01-01,10029028,1000003251,33.57。</span><br><span class="line">请给出sql进行统计:</span><br><span class="line">(1)给出 2017年每个月的订单数、用户数、总成交金额。</span><br><span class="line">(2)给出2017年11月的新客数(指在11月才有第一笔订单)</span><br></pre></td></tr></table></figure>
<p>数据准备:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test3 ( </span><br><span class="line">            dt string,</span><br><span class="line">            order_id string, </span><br><span class="line">            user_id string, </span><br><span class="line">            amount <span class="type">DECIMAL</span> ( <span class="number">10</span>, <span class="number">2</span> ) )</span><br><span class="line"><span class="type">ROW</span> format delimited FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test3 <span class="keyword">VALUES</span> (<span class="string">&#x27;2017-01-01&#x27;</span>,<span class="string">&#x27;10029028&#x27;</span>,<span class="string">&#x27;1000003251&#x27;</span>,<span class="number">33.57</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test3 <span class="keyword">VALUES</span> (<span class="string">&#x27;2017-01-01&#x27;</span>,<span class="string">&#x27;10029029&#x27;</span>,<span class="string">&#x27;1000003251&#x27;</span>,<span class="number">33.57</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test3 <span class="keyword">VALUES</span> (<span class="string">&#x27;2017-01-01&#x27;</span>,<span class="string">&#x27;100290288&#x27;</span>,<span class="string">&#x27;1000003252&#x27;</span>,<span class="number">33.57</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test3 <span class="keyword">VALUES</span> (<span class="string">&#x27;2017-02-02&#x27;</span>,<span class="string">&#x27;10029088&#x27;</span>,<span class="string">&#x27;1000003251&#x27;</span>,<span class="number">33.57</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test3 <span class="keyword">VALUES</span> (<span class="string">&#x27;2017-02-02&#x27;</span>,<span class="string">&#x27;100290281&#x27;</span>,<span class="string">&#x27;1000003251&#x27;</span>,<span class="number">33.57</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test3 <span class="keyword">VALUES</span> (<span class="string">&#x27;2017-02-02&#x27;</span>,<span class="string">&#x27;100290282&#x27;</span>,<span class="string">&#x27;1000003253&#x27;</span>,<span class="number">33.57</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test3 <span class="keyword">VALUES</span> (<span class="string">&#x27;2017-11-02&#x27;</span>,<span class="string">&#x27;10290282&#x27;</span>,<span class="string">&#x27;100003253&#x27;</span>,<span class="number">234</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test3 <span class="keyword">VALUES</span> (<span class="string">&#x27;2018-11-02&#x27;</span>,<span class="string">&#x27;10290284&#x27;</span>,<span class="string">&#x27;100003243&#x27;</span>,<span class="number">234</span>);</span><br></pre></td></tr></table></figure>

<p>查询SQL：<br>(1)给出 2017年每个月的订单数、用户数、总成交金额。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    date_format(dt,<span class="string">&#x27;YYYY-MM&#x27;</span>) <span class="keyword">as</span> mon,</span><br><span class="line">    <span class="built_in">count</span>(order_id) <span class="keyword">as</span> order_cnt,</span><br><span class="line">    <span class="built_in">count</span>(user_id) <span class="keyword">as</span> user_cnt,</span><br><span class="line">    <span class="built_in">sum</span>(amount) <span class="keyword">as</span> AMT</span><br><span class="line"><span class="keyword">from</span> prac.test3</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> date_format(dt,<span class="string">&#x27;YYYY-MM&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>(2)给出2017年11月的新客数(指在11月才有第一笔订单)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">with t1 as(</span><br><span class="line">    select</span><br><span class="line">        user_id</span><br><span class="line">    from prac.test3</span><br><span class="line">    where dt&lt;to_date(&#x27;2017-11-01&#x27;)</span><br><span class="line">)</span><br><span class="line">select</span><br><span class="line">    date_format(dt,&#x27;YYYY-MM&#x27;),</span><br><span class="line">    count(1)</span><br><span class="line">from prac.test3</span><br><span class="line">where dt between &#x27;2017-11-01&#x27; and &#x27;2017-11-30&#x27;</span><br><span class="line"> and user_id not in (select t1.user_id from t1)</span><br><span class="line">group by date_format(dt,&#x27;YYYY-MM&#x27;)</span><br></pre></td></tr></table></figure>
<p>不得不说答案上的这个写法真的很巧妙:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(user_id)</span><br><span class="line"><span class="keyword">FROM</span> prac.test3</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id</span><br><span class="line"><span class="keyword">HAVING</span> date_format(<span class="built_in">min</span>(dt),<span class="string">&#x27;yyyy-MM&#x27;</span>)<span class="operator">=</span><span class="string">&#x27;2017-11&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="第四题"><a href="#第四题" class="headerlink" title="第四题"></a>第四题</h2><p>需求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">有一个5000万的用户文件(user_id，name，age)，一个2亿记录的用户看电影的记录文件(user_id，url)，根据年龄段观看电影的次数进行排序？        </span><br></pre></td></tr></table></figure>
<p>数据准备：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test4user</span><br><span class="line">           (user_id string,</span><br><span class="line">            name string,</span><br><span class="line">            age <span class="type">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test4log</span><br><span class="line">                        (user_id string,</span><br><span class="line">                        url string);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test4user <span class="keyword">VALUES</span></span><br><span class="line"> (<span class="string">&#x27;001&#x27;</span>,<span class="string">&#x27;u1&#x27;</span>,<span class="number">10</span>)</span><br><span class="line">,(<span class="string">&#x27;002&#x27;</span>,<span class="string">&#x27;u2&#x27;</span>,<span class="number">15</span>)</span><br><span class="line">,(<span class="string">&#x27;003&#x27;</span>,<span class="string">&#x27;u3&#x27;</span>,<span class="number">15</span>)  </span><br><span class="line">,(<span class="string">&#x27;004&#x27;</span>,<span class="string">&#x27;u4&#x27;</span>,<span class="number">20</span>) </span><br><span class="line">,(<span class="string">&#x27;005&#x27;</span>,<span class="string">&#x27;u5&#x27;</span>,<span class="number">25</span>)</span><br><span class="line">,(<span class="string">&#x27;006&#x27;</span>,<span class="string">&#x27;u6&#x27;</span>,<span class="number">35</span>) </span><br><span class="line">,(<span class="string">&#x27;007&#x27;</span>,<span class="string">&#x27;u7&#x27;</span>,<span class="number">40</span>)</span><br><span class="line">,(<span class="string">&#x27;008&#x27;</span>,<span class="string">&#x27;u8&#x27;</span>,<span class="number">45</span>)</span><br><span class="line">,(<span class="string">&#x27;009&#x27;</span>,<span class="string">&#x27;u9&#x27;</span>,<span class="number">50</span>)</span><br><span class="line">,(<span class="string">&#x27;0010&#x27;</span>,<span class="string">&#x27;u10&#x27;</span>,<span class="number">65</span>);  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test4log <span class="keyword">VALUES</span></span><br><span class="line"> (<span class="string">&#x27;001&#x27;</span>,<span class="string">&#x27;url1&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;002&#x27;</span>,<span class="string">&#x27;url1&#x27;</span>)  </span><br><span class="line">,(<span class="string">&#x27;003&#x27;</span>,<span class="string">&#x27;url2&#x27;</span>)  </span><br><span class="line">,(<span class="string">&#x27;004&#x27;</span>,<span class="string">&#x27;url3&#x27;</span>)  </span><br><span class="line">,(<span class="string">&#x27;005&#x27;</span>,<span class="string">&#x27;url3&#x27;</span>)  </span><br><span class="line">,(<span class="string">&#x27;006&#x27;</span>,<span class="string">&#x27;url1&#x27;</span>)  </span><br><span class="line">,(<span class="string">&#x27;007&#x27;</span>,<span class="string">&#x27;url5&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;008&#x27;</span>,<span class="string">&#x27;url7&#x27;</span>) </span><br><span class="line">,(<span class="string">&#x27;009&#x27;</span>,<span class="string">&#x27;url5&#x27;</span>) </span><br><span class="line">,(<span class="string">&#x27;0010&#x27;</span>,<span class="string">&#x27;url1&#x27;</span>); </span><br></pre></td></tr></table></figure>
<p>查询SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        user_id,</span><br><span class="line">        <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> move_cnt</span><br><span class="line">    <span class="keyword">from</span> prac.test4log</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> user_id</span><br><span class="line">),t2 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        user_id,</span><br><span class="line">        name,</span><br><span class="line">        (<span class="keyword">case</span> <span class="keyword">when</span> age<span class="operator">&gt;=</span><span class="number">0</span>  <span class="keyword">and</span> age<span class="operator">&lt;</span><span class="number">10</span> <span class="keyword">then</span> <span class="string">&#x27;0-9&#x27;</span></span><br><span class="line">              <span class="keyword">when</span> age<span class="operator">&gt;=</span><span class="number">10</span> <span class="keyword">and</span> age<span class="operator">&lt;</span><span class="number">20</span> <span class="keyword">then</span> <span class="string">&#x27;10-19&#x27;</span></span><br><span class="line">              <span class="keyword">when</span> age<span class="operator">&gt;=</span><span class="number">20</span> <span class="keyword">and</span> age<span class="operator">&lt;</span><span class="number">30</span> <span class="keyword">then</span> <span class="string">&#x27;20-29&#x27;</span></span><br><span class="line">              <span class="keyword">when</span> age<span class="operator">&gt;=</span><span class="number">30</span> <span class="keyword">and</span> age<span class="operator">&lt;</span><span class="number">40</span> <span class="keyword">then</span> <span class="string">&#x27;30-39&#x27;</span></span><br><span class="line">              <span class="keyword">when</span> age<span class="operator">&gt;=</span><span class="number">40</span> <span class="keyword">and</span> age<span class="operator">&lt;</span><span class="number">50</span> <span class="keyword">then</span> <span class="string">&#x27;40-49&#x27;</span></span><br><span class="line">              <span class="keyword">when</span> age<span class="operator">&gt;=</span><span class="number">50</span> <span class="keyword">and</span> age<span class="operator">&lt;</span><span class="number">60</span> <span class="keyword">then</span> <span class="string">&#x27;50-59&#x27;</span></span><br><span class="line">              <span class="keyword">when</span> age<span class="operator">&gt;=</span><span class="number">60</span> <span class="keyword">and</span> age<span class="operator">&lt;</span><span class="number">70</span> <span class="keyword">then</span> <span class="string">&#x27;60-69&#x27;</span></span><br><span class="line">              <span class="keyword">when</span> age<span class="operator">&gt;=</span><span class="number">70</span> <span class="keyword">and</span> age<span class="operator">&lt;</span><span class="number">80</span> <span class="keyword">then</span> <span class="string">&#x27;70-79&#x27;</span></span><br><span class="line">       <span class="keyword">else</span> <span class="string">&#x27;80及以上&#x27;</span> <span class="keyword">end</span>) <span class="keyword">as</span> age_peroid</span><br><span class="line">    <span class="keyword">from</span> prac.test4user</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    t2.age_peroid,</span><br><span class="line">    <span class="built_in">sum</span>(t1.move_cnt)</span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">join</span> t2</span><br><span class="line">  <span class="keyword">on</span> t1.user_id<span class="operator">=</span>t2.user_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> age_peroid;</span><br></pre></td></tr></table></figure>
<h2 id="第五题"><a href="#第五题" class="headerlink" title="第五题"></a>第五题</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">有日志如下，请写出代码求得所有用户和活跃用户的总数及平均年龄。（活跃用户指连续两天都有访问记录的用户）</span><br><span class="line">日期 用户 年龄</span><br><span class="line">2019-02-11,test_1,23</span><br><span class="line">2019-02-11,test_2,19</span><br><span class="line">2019-02-11,test_3,39</span><br><span class="line">2019-02-11,test_1,23</span><br><span class="line">2019-02-11,test_3,39</span><br><span class="line">2019-02-11,test_1,23</span><br><span class="line">2019-02-12,test_2,19</span><br><span class="line">2019-02-13,test_1,23</span><br><span class="line">2019-02-15,test_2,19</span><br><span class="line">2019-02-16,test_2,19</span><br></pre></td></tr></table></figure>
<p>数据准备：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test5(</span><br><span class="line">dt string,</span><br><span class="line">user_id string,</span><br><span class="line">age <span class="type">int</span>)</span><br><span class="line"><span class="type">ROW</span> format delimited fields terminated <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test5 <span class="keyword">VALUES</span> </span><br><span class="line"> (<span class="string">&#x27;2019-02-11&#x27;</span>,<span class="string">&#x27;test_1&#x27;</span>,<span class="number">23</span>)</span><br><span class="line">,(<span class="string">&#x27;2019-02-11&#x27;</span>,<span class="string">&#x27;test_2&#x27;</span>,<span class="number">19</span>)</span><br><span class="line">,(<span class="string">&#x27;2019-02-11&#x27;</span>,<span class="string">&#x27;test_3&#x27;</span>,<span class="number">39</span>)</span><br><span class="line">,(<span class="string">&#x27;2019-02-11&#x27;</span>,<span class="string">&#x27;test_1&#x27;</span>,<span class="number">23</span>)</span><br><span class="line">,(<span class="string">&#x27;2019-02-11&#x27;</span>,<span class="string">&#x27;test_3&#x27;</span>,<span class="number">39</span>)</span><br><span class="line">,(<span class="string">&#x27;2019-02-11&#x27;</span>,<span class="string">&#x27;test_1&#x27;</span>,<span class="number">23</span>)</span><br><span class="line">,(<span class="string">&#x27;2019-02-12&#x27;</span>,<span class="string">&#x27;test_2&#x27;</span>,<span class="number">19</span>)</span><br><span class="line">,(<span class="string">&#x27;2019-02-13&#x27;</span>,<span class="string">&#x27;test_1&#x27;</span>,<span class="number">23</span>)</span><br><span class="line">,(<span class="string">&#x27;2019-02-15&#x27;</span>,<span class="string">&#x27;test_2&#x27;</span>,<span class="number">19</span>)                                  </span><br><span class="line">,(<span class="string">&#x27;2019-02-16&#x27;</span>,<span class="string">&#x27;test_2&#x27;</span>,<span class="number">19</span>);</span><br></pre></td></tr></table></figure>
<p>查询SQL：<br>求得所有用户和活跃用户的总数及平均年龄。（活跃用户指连续两天都有访问记录的用户）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> cnt_all,</span><br><span class="line">        <span class="built_in">avg</span>(age) <span class="keyword">as</span> avg_all</span><br><span class="line">    <span class="keyword">from</span>( </span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_id,</span><br><span class="line">            age</span><br><span class="line">        <span class="keyword">from</span> prac.test5</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> user_id,age</span><br><span class="line">    )</span><br><span class="line">),t2 <span class="keyword">as</span> (</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    t4.user_id,</span><br><span class="line">    t4.age</span><br><span class="line"><span class="keyword">from</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        t3.user_id,</span><br><span class="line">        t3.age</span><br><span class="line">    <span class="keyword">from</span>(</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            dt,</span><br><span class="line">            user_id,</span><br><span class="line">            age,</span><br><span class="line">            rk,</span><br><span class="line">            date_sub(dt,rk) <span class="keyword">as</span> flag</span><br><span class="line">        <span class="keyword">from</span> (</span><br><span class="line">            <span class="keyword">select</span></span><br><span class="line">                t0.dt,</span><br><span class="line">                t0.user_id,</span><br><span class="line">                t0.age,</span><br><span class="line">                <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> t1.user_id <span class="keyword">order</span> <span class="keyword">by</span> t1.dt) <span class="keyword">as</span> rk</span><br><span class="line">            <span class="keyword">from</span>(</span><br><span class="line">                <span class="keyword">select</span></span><br><span class="line">                    dt,</span><br><span class="line">                    user_id,</span><br><span class="line">                    age</span><br><span class="line">                <span class="keyword">from</span> prac.test5</span><br><span class="line">                <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                    dt,</span><br><span class="line">                    user_id,</span><br><span class="line">                    age</span><br><span class="line">            ) <span class="keyword">as</span> t0 <span class="comment">-- 对用户访问表去重</span></span><br><span class="line">        )</span><br><span class="line">    ) <span class="keyword">as</span> t3</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        t3.user_id,</span><br><span class="line">        t3.age,</span><br><span class="line">        t3.flag</span><br><span class="line">    <span class="keyword">having</span> <span class="built_in">count</span>(<span class="number">1</span>)<span class="operator">&gt;=</span><span class="number">2</span></span><br><span class="line">) <span class="keyword">as</span> t4</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    t4.user_id,</span><br><span class="line">    t4.age</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	<span class="built_in">count</span>(t2.user_id),</span><br><span class="line">	<span class="built_in">avg</span>(t2.age)</span><br><span class="line"><span class="keyword">from</span> t2</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	cnt_all,</span><br><span class="line">	avg_all</span><br><span class="line"><span class="keyword">from</span> t1;</span><br></pre></td></tr></table></figure>
<p>这道题比较复杂，难度在于如何求活跃用户，首先对用户活跃日志进行去重，每个用户每天只保留一条，然后对其按照用户分组，按照日期升序，使用row_number对其打上序号rk。<br>不难看出，如果是连续登录，那么日期dt和序号会是一个等差数列，故用登陆日期dt和序号做差，得到新的日期起别名flag。然后按照user_id和flag进行分组，如果一个分组内的数据量大于等于2，就说明这位用户是活跃用户。得到活跃用户，再一次进行去重操作，因为同一用户可能多次活跃，被判定为多次活跃用户。得到活跃用户再求他们的数量和平均年龄就比较简单了。</p>
<h2 id="第六题"><a href="#第六题" class="headerlink" title="第六题"></a>第六题</h2><p>需求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">请用sql写出所有用户中在今年10月份第一次购买商品的金额，</span><br><span class="line">表ordertable字段:</span><br><span class="line">(购买用户：userid，金额：money，购买时间：paymenttime(格式：2017-10-01)，订单id：orderid           </span><br></pre></td></tr></table></figure>
<p>数据准备:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test6 (</span><br><span class="line">        userid string,</span><br><span class="line">        money <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">        paymenttime string,</span><br><span class="line">        orderid string);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test6 <span class="keyword">VALUES</span></span><br><span class="line"> (<span class="string">&#x27;001&#x27;</span>,<span class="number">100</span>,<span class="string">&#x27;2017-10-01&#x27;</span>,<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;001&#x27;</span>,<span class="number">200</span>,<span class="string">&#x27;2017-10-02&#x27;</span>,<span class="string">&#x27;124&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;002&#x27;</span>,<span class="number">500</span>,<span class="string">&#x27;2017-10-01&#x27;</span>,<span class="string">&#x27;125&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;001&#x27;</span>,<span class="number">100</span>,<span class="string">&#x27;2017-11-01&#x27;</span>,<span class="string">&#x27;126&#x27;</span>);    </span><br></pre></td></tr></table></figure>
<p>查询SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    userid,</span><br><span class="line">    money,</span><br><span class="line">    <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> userid <span class="keyword">order</span> <span class="keyword">by</span> paymenttime) rk</span><br><span class="line"><span class="keyword">from</span> prac.test6</span><br><span class="line"><span class="keyword">where</span> paymenttime<span class="operator">&gt;=</span><span class="string">&#x27;2017-10-01&#x27;</span> <span class="keyword">and</span> paymenttime<span class="operator">&lt;=</span><span class="string">&#x27;2017-10-31&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    userid,</span><br><span class="line">    money</span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">where</span> rk<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h2 id="第七题"><a href="#第七题" class="headerlink" title="第七题"></a>第七题</h2><p>需求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">现有图书管理数据库的三个数据模型如下：</span><br><span class="line">图书（数据表名：BOOK）</span><br><span class="line">    序号      字段名称    字段描述    字段类型</span><br><span class="line">    1       BOOK_ID     总编号         文本</span><br><span class="line">    2       SORT        分类号         文本</span><br><span class="line">    3       BOOK_NAME   书名          文本</span><br><span class="line">    4       WRITER      作者          文本</span><br><span class="line">    5       OUTPUT      出版单位    文本</span><br><span class="line">    6       PRICE       单价          数值（保留小数点后2位）</span><br><span class="line">读者（数据表名：READER）</span><br><span class="line">    序号      字段名称    字段描述    字段类型</span><br><span class="line">    1       READER_ID   借书证号    文本</span><br><span class="line">    2       COMPANY     单位          文本</span><br><span class="line">    3       NAME        姓名          文本</span><br><span class="line">    4       SEX         性别          文本</span><br><span class="line">    5       GRADE       职称          文本</span><br><span class="line">    6       ADDR        地址          文本</span><br><span class="line">借阅记录（数据表名：BORROW LOG）</span><br><span class="line">    序号      字段名称        字段描述    字段类型</span><br><span class="line">    1       READER_ID       借书证号    文本</span><br><span class="line">    2       BOOK_ID         总编号         文本</span><br><span class="line">    3       BORROW_DATE     借书日期    日期</span><br><span class="line">（1）创建图书管理库的图书、读者和借阅三个基本表的表结构。请写出建表语句。</span><br><span class="line">（2）找出姓李的读者姓名（NAME）和所在单位（COMPANY）。</span><br><span class="line">（3）查找“高等教育出版社”的所有图书名称（BOOK_NAME）及单价（PRICE），结果按单价降序排序。</span><br><span class="line">（4）查找价格介于10元和20元之间的图书种类(SORT）出版单位（OUTPUT）和单价（PRICE），结果按出版单位（OUTPUT）和单价（PRICE）升序排序。</span><br><span class="line">（5）查找所有借了书的读者的姓名（NAME）及所在单位（COMPANY）。</span><br><span class="line">（6）求”科学出版社”图书的最高单价、最低单价、平均单价。</span><br><span class="line">（7）找出当前至少借阅了2本图书（大于等于2本）的读者姓名及其所在单位。</span><br><span class="line">（8）考虑到数据安全的需要，需定时将“借阅记录”中数据进行备份，请使用一条SQL语句，在备份用户bak下创建与“借阅记录”表结构完全一致的数据表BORROW_LOG_BAK.井且将“借阅记录”中现有数据全部复制到BORROW_L0G_ BAK中。</span><br><span class="line">（9）现在需要将原Oracle数据库中数据迁移至Hive仓库，请写出“图书”在Hive中的建表语句（Hive实现，提示：列分隔符|；数据表数据需要外部导入：分区分别以month＿part、day＿part 命名）</span><br><span class="line">（10）Hive中有表A，现在需要将表A的月分区　201505　中　user＿id为20000的user＿dinner字段更新为bonc8920，其他用户user＿dinner字段数据不变，请列出更新的方法步骤。（Hive实现，提示：Hlive中无update语法，请通过其他办法进行数据更新）</span><br></pre></td></tr></table></figure>
<p>(1)数据准备：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.book(book_id string,</span><br><span class="line">                           `SORT` string,</span><br><span class="line">                           book_name string,</span><br><span class="line">                           writer string,</span><br><span class="line">                           OUTPUT string,</span><br><span class="line">                           price <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.book <span class="keyword">VALUES</span> (<span class="string">&#x27;001&#x27;</span>,<span class="string">&#x27;TP391&#x27;</span>,<span class="string">&#x27;信息处理&#x27;</span>,<span class="string">&#x27;author1&#x27;</span>,<span class="string">&#x27;机械工业出版社&#x27;</span>,<span class="string">&#x27;20&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.book <span class="keyword">VALUES</span> (<span class="string">&#x27;002&#x27;</span>,<span class="string">&#x27;TP392&#x27;</span>,<span class="string">&#x27;数据库&#x27;</span>,<span class="string">&#x27;author12&#x27;</span>,<span class="string">&#x27;科学出版社&#x27;</span>,<span class="string">&#x27;15&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.book <span class="keyword">VALUES</span> (<span class="string">&#x27;003&#x27;</span>,<span class="string">&#x27;TP393&#x27;</span>,<span class="string">&#x27;计算机网络&#x27;</span>,<span class="string">&#x27;author3&#x27;</span>,<span class="string">&#x27;机械工业出版社&#x27;</span>,<span class="string">&#x27;29&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.book <span class="keyword">VALUES</span> (<span class="string">&#x27;004&#x27;</span>,<span class="string">&#x27;TP399&#x27;</span>,<span class="string">&#x27;微机原理&#x27;</span>,<span class="string">&#x27;author4&#x27;</span>,<span class="string">&#x27;科学出版社&#x27;</span>,<span class="string">&#x27;39&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.book <span class="keyword">VALUES</span> (<span class="string">&#x27;005&#x27;</span>,<span class="string">&#x27;C931&#x27;</span>,<span class="string">&#x27;管理信息系统&#x27;</span>,<span class="string">&#x27;author5&#x27;</span>,<span class="string">&#x27;机械工业出版社&#x27;</span>,<span class="string">&#x27;40&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.book <span class="keyword">VALUES</span> (<span class="string">&#x27;006&#x27;</span>,<span class="string">&#x27;C932&#x27;</span>,<span class="string">&#x27;运筹学&#x27;</span>,<span class="string">&#x27;author6&#x27;</span>,<span class="string">&#x27;科学出版社&#x27;</span>,<span class="string">&#x27;55&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建读者表reader</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.reader (reader_id string,</span><br><span class="line">                              company string,</span><br><span class="line">                              name string,</span><br><span class="line">                              sex string,</span><br><span class="line">                              grade string,</span><br><span class="line">                              addr string);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.reader <span class="keyword">VALUES</span> (<span class="string">&#x27;0001&#x27;</span>,<span class="string">&#x27;阿里巴巴&#x27;</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;vp&#x27;</span>,<span class="string">&#x27;addr1&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.reader <span class="keyword">VALUES</span> (<span class="string">&#x27;0002&#x27;</span>,<span class="string">&#x27;百度&#x27;</span>,<span class="string">&#x27;robin&#x27;</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;vp&#x27;</span>,<span class="string">&#x27;addr2&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.reader <span class="keyword">VALUES</span> (<span class="string">&#x27;0003&#x27;</span>,<span class="string">&#x27;腾讯&#x27;</span>,<span class="string">&#x27;tony&#x27;</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;vp&#x27;</span>,<span class="string">&#x27;addr3&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.reader <span class="keyword">VALUES</span> (<span class="string">&#x27;0004&#x27;</span>,<span class="string">&#x27;京东&#x27;</span>,<span class="string">&#x27;jasper&#x27;</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;cfo&#x27;</span>,<span class="string">&#x27;addr4&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.reader <span class="keyword">VALUES</span> (<span class="string">&#x27;0005&#x27;</span>,<span class="string">&#x27;网易&#x27;</span>,<span class="string">&#x27;zhangsan&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;ceo&#x27;</span>,<span class="string">&#x27;addr5&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.reader <span class="keyword">VALUES</span> (<span class="string">&#x27;0006&#x27;</span>,<span class="string">&#x27;搜狐&#x27;</span>,<span class="string">&#x27;lisi&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;ceo&#x27;</span>,<span class="string">&#x27;addr6&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建借阅记录表borrow_log</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.borrow_log(reader_id string,</span><br><span class="line">                                 book_id string,</span><br><span class="line">                                 borrow_date string);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.borrow_log <span class="keyword">VALUES</span> (<span class="string">&#x27;0001&#x27;</span>,<span class="string">&#x27;002&#x27;</span>,<span class="string">&#x27;2019-10-14&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.borrow_log <span class="keyword">VALUES</span> (<span class="string">&#x27;0002&#x27;</span>,<span class="string">&#x27;001&#x27;</span>,<span class="string">&#x27;2019-10-13&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.borrow_log <span class="keyword">VALUES</span> (<span class="string">&#x27;0003&#x27;</span>,<span class="string">&#x27;005&#x27;</span>,<span class="string">&#x27;2019-09-14&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.borrow_log <span class="keyword">VALUES</span> (<span class="string">&#x27;0004&#x27;</span>,<span class="string">&#x27;006&#x27;</span>,<span class="string">&#x27;2019-08-15&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.borrow_log <span class="keyword">VALUES</span> (<span class="string">&#x27;0005&#x27;</span>,<span class="string">&#x27;003&#x27;</span>,<span class="string">&#x27;2019-10-10&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.borrow_log <span class="keyword">VALUES</span> (<span class="string">&#x27;0006&#x27;</span>,<span class="string">&#x27;004&#x27;</span>,<span class="string">&#x27;2019-17-13&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>(2)找出姓李的读者姓名（NAME）和所在单位（COMPANY）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    name,</span><br><span class="line">    company</span><br><span class="line"><span class="keyword">from</span> prac.reader</span><br><span class="line"><span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;li%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>(3)查找“高等教育出版社”的所有图书名称（BOOK_NAME）及单价（PRICE），结果按单价降序排序。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    book_name,</span><br><span class="line">    price</span><br><span class="line"><span class="keyword">from</span> prac.book</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> price <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<p>(4)查找价格介于10元和20元之间的图书种类(SORT）出版单位（OUTPUT）和单价（PRICE），结果按出版单位（OUTPUT）和单价（PRICE）升序排序。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    sort,</span><br><span class="line">    output,</span><br><span class="line">    price</span><br><span class="line"><span class="keyword">from</span> prac.book</span><br><span class="line"><span class="keyword">where</span> price<span class="operator">&gt;=</span><span class="number">10</span> <span class="keyword">and</span> price<span class="operator">&lt;=</span><span class="number">20</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> output,price;</span><br></pre></td></tr></table></figure>
<p>(5)查找所有借了书的读者的姓名（NAME）及所在单位（COMPANY）。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    b.name,</span><br><span class="line">    b.company</span><br><span class="line"><span class="keyword">from</span> borrow_log <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> reader <span class="keyword">as</span> b</span><br><span class="line">       <span class="keyword">on</span> a.reader_id<span class="operator">=</span>b.reader_id</span><br></pre></td></tr></table></figure>
<p>(6)求科学出版社图书的最高单价、最低单价、平均单价。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="built_in">max</span>(price),</span><br><span class="line">    <span class="built_in">min</span>(price),</span><br><span class="line">    <span class="built_in">avg</span>(price)</span><br><span class="line"><span class="keyword">from</span> prac.book</span><br><span class="line"><span class="keyword">where</span> output<span class="operator">=</span><span class="string">&#x27;科学出版社&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>(7)找出当前至少借阅了2本图书（大于等于2本）的读者姓名及其所在单位</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        reader_id,</span><br><span class="line">        <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> cnt</span><br><span class="line">    <span class="keyword">from</span> borrow_log</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> reader_id</span><br><span class="line">    <span class="keyword">having</span> cnt<span class="operator">&gt;=</span><span class="number">2</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    t2.name,</span><br><span class="line">    t2.company</span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> reader <span class="keyword">as</span> t2</span><br><span class="line"><span class="keyword">on</span> t1.reader_id<span class="operator">=</span>t2.reader_id;</span><br></pre></td></tr></table></figure>
<p>(8)考虑到数据安全的需要，需定时将“借阅记录”中数据进行备份，请使用一条SQL语句，<br>在备份用户bak下创建与“借阅记录”表结构完全一致的数据表BORROW_LOG_BAK.井且将“借阅记录”中现有数据全部复制到BORROW_L0G_ BAK中。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.borrow_log_bak <span class="keyword">AS</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">    <span class="keyword">FROM</span> prac.borrow_log;</span><br></pre></td></tr></table></figure>
<p>(9)现在需要将原Oracle数据库中数据迁移至Hive仓库，请写出“图书”在Hive中的建表语句（Hive实现，提示：列分隔符|；数据表数据需要外部导入：分区分别以month＿part、day＿part 命名）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> book2;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> book2(</span><br><span class="line"> BOOK_ID     STRING    COMMENT    <span class="string">&#x27;总编号&#x27;</span></span><br><span class="line">,SORT        STRING    COMMENT    <span class="string">&#x27;分类号&#x27;</span></span><br><span class="line">,BOOK_NAME   STRING    COMMENT    <span class="string">&#x27;书名&#x27;</span></span><br><span class="line">,WRITER      STRING    COMMENT    <span class="string">&#x27;作者&#x27;</span></span><br><span class="line">,OUTPUT      STRING    COMMENT    <span class="string">&#x27;出版单位&#x27;</span></span><br><span class="line">,PRICE       STRING    COMMENT    <span class="string">&#x27;单价&#x27;</span></span><br><span class="line">)COMMENT <span class="string">&#x27;图书表&#x27;</span></span><br><span class="line">partitioned <span class="keyword">by</span>(month_part string COMMENT <span class="string">&#x27;月分区&#x27;</span>,day_part string COMMENT <span class="string">&#x27;日分区&#x27;</span>)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;|&#x27;</span> stored <span class="keyword">as</span> textfile;</span><br></pre></td></tr></table></figure>
<p>(10)Hive中有表A，现在需要将表A的月分区 201505 中 user_id为20000的user_dinner字段更新为bonc8920，其他用户user_dinner字段数据不变，请列出更新的方法步骤。</p>
<ul>
<li>1.新建临时表写入更改过的数据</li>
<li>2.把临时表数据写回原分区</li>
</ul>
<h2 id="第八题"><a href="#第八题" class="headerlink" title="第八题"></a>第八题</h2><p>需求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">有一个线上服务器访问日志格式如下（用sql答题）</span><br><span class="line">时间                    接口                         ip地址</span><br><span class="line">2016-11-09 14:22:05        /api/user/login             110.23.5.33</span><br><span class="line">2016-11-09 14:23:10        /api/user/detail            57.3.2.16</span><br><span class="line">2016-11-09 15:59:40        /api/user/login             200.6.5.166</span><br><span class="line">… …</span><br><span class="line">求11月9号下午14点（14-15点），访问/api/user/login接口的top10的ip地址       </span><br></pre></td></tr></table></figure>
<p>数据准备：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test8(`<span class="type">date</span>` string,</span><br><span class="line">                interface string,</span><br><span class="line">                ip string);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test8 <span class="keyword">VALUES</span> </span><br><span class="line"> (<span class="string">&#x27;2016-11-09 11:22:05&#x27;</span>,<span class="string">&#x27;/api/user/login&#x27;</span>,<span class="string">&#x27;110.23.5.23&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 11:23:10&#x27;</span>,<span class="string">&#x27;/api/user/detail&#x27;</span>,<span class="string">&#x27;57.3.2.16&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 23:59:40&#x27;</span>,<span class="string">&#x27;/api/user/login&#x27;</span>,<span class="string">&#x27;200.6.5.166&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 11:14:23&#x27;</span>,<span class="string">&#x27;/api/user/login&#x27;</span>,<span class="string">&#x27;136.79.47.70&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 11:15:23&#x27;</span>,<span class="string">&#x27;/api/user/detail&#x27;</span>,<span class="string">&#x27;94.144.143.141&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 11:16:23&#x27;</span>,<span class="string">&#x27;/api/user/login&#x27;</span>,<span class="string">&#x27;197.161.8.206&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 12:14:23&#x27;</span>,<span class="string">&#x27;/api/user/detail&#x27;</span>,<span class="string">&#x27;240.227.107.145&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 13:14:23&#x27;</span>,<span class="string">&#x27;/api/user/login&#x27;</span>,<span class="string">&#x27;79.130.122.205&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 14:14:23&#x27;</span>,<span class="string">&#x27;/api/user/detail&#x27;</span>,<span class="string">&#x27;65.228.251.189&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 14:15:23&#x27;</span>,<span class="string">&#x27;/api/user/detail&#x27;</span>,<span class="string">&#x27;245.23.122.44&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 14:17:23&#x27;</span>,<span class="string">&#x27;/api/user/detail&#x27;</span>,<span class="string">&#x27;22.74.142.137&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 14:19:23&#x27;</span>,<span class="string">&#x27;/api/user/detail&#x27;</span>,<span class="string">&#x27;54.93.212.87&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 14:20:23&#x27;</span>,<span class="string">&#x27;/api/user/detail&#x27;</span>,<span class="string">&#x27;218.15.167.248&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 14:24:23&#x27;</span>,<span class="string">&#x27;/api/user/detail&#x27;</span>,<span class="string">&#x27;20.117.19.75&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 15:14:23&#x27;</span>,<span class="string">&#x27;/api/user/login&#x27;</span>,<span class="string">&#x27;183.162.66.97&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 16:14:23&#x27;</span>,<span class="string">&#x27;/api/user/login&#x27;</span>,<span class="string">&#x27;108.181.245.147&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 14:17:23&#x27;</span>,<span class="string">&#x27;/api/user/login&#x27;</span>,<span class="string">&#x27;22.74.142.137&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2016-11-09 14:19:23&#x27;</span>,<span class="string">&#x27;/api/user/login&#x27;</span>,<span class="string">&#x27;22.74.142.137&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>查询SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        date_format(`<span class="type">date</span>`,<span class="string">&#x27;YYYY-MM-dd HH&#x27;</span>) <span class="keyword">as</span> dt,</span><br><span class="line">        ip,</span><br><span class="line">        <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> cnt</span><br><span class="line">    <span class="keyword">from</span> test8</span><br><span class="line">    <span class="keyword">where</span> date_format(`<span class="type">date</span>`,<span class="string">&#x27;YYYY-MM-dd HH&#x27;</span>)<span class="operator">=</span><span class="string">&#x27;2016-11-09 14&#x27;</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> date_format(`<span class="type">date</span>`,<span class="string">&#x27;YYYY-MM-dd HH&#x27;</span>),ip</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    dt,</span><br><span class="line">    ip,</span><br><span class="line">    rk</span><br><span class="line"><span class="keyword">from</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        dt,</span><br><span class="line">        ip,</span><br><span class="line">        <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span>) <span class="keyword">as</span> rk</span><br><span class="line">    <span class="keyword">from</span> t1</span><br><span class="line">) <span class="keyword">as</span> t2</span><br><span class="line"><span class="keyword">where</span> rk<span class="operator">&lt;=</span><span class="number">10</span>;    </span><br></pre></td></tr></table></figure>
<h2 id="第九题"><a href="#第九题" class="headerlink" title="第九题"></a>第九题</h2><p>需求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">有一个充值日志表credit_log，字段如下：</span><br><span class="line">`dist_id` int  &#x27;区组id&#x27;,</span><br><span class="line">`account` string  &#x27;账号&#x27;,</span><br><span class="line">`money` int   &#x27;充值金额&#x27;,</span><br><span class="line">`create_time` string  &#x27;订单时间&#x27;</span><br><span class="line"></span><br><span class="line">请写出SQL语句，查询充值日志表2019年01月02号每个区组下充值额最大的账号，要求结果：</span><br><span class="line">区组id，账号，金额，充值时间      </span><br></pre></td></tr></table></figure>
<p>数据准备：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test9(</span><br><span class="line">            dist_id string COMMENT <span class="string">&#x27;区组id&#x27;</span>,</span><br><span class="line">            account string COMMENT <span class="string">&#x27;账号&#x27;</span>,</span><br><span class="line">           `money` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) COMMENT <span class="string">&#x27;充值金额&#x27;</span>,</span><br><span class="line">            create_time string COMMENT <span class="string">&#x27;订单时间&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test9 <span class="keyword">VALUES</span> </span><br><span class="line"> (<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;11&#x27;</span>,<span class="number">100006</span>,<span class="string">&#x27;2019-01-02 13:00:01&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="number">110000</span>,<span class="string">&#x27;2019-01-02 13:00:02&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;33&#x27;</span>,<span class="number">102000</span>,<span class="string">&#x27;2019-01-02 13:00:03&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;44&#x27;</span>,<span class="number">100300</span>,<span class="string">&#x27;2019-01-02 13:00:04&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;55&#x27;</span>,<span class="number">100040</span>,<span class="string">&#x27;2019-01-02 13:00:05&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;66&#x27;</span>,<span class="number">100005</span>,<span class="string">&#x27;2019-01-02 13:00:06&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;77&#x27;</span>,<span class="number">180000</span>,<span class="string">&#x27;2019-01-03 13:00:07&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;88&#x27;</span>,<span class="number">106000</span>,<span class="string">&#x27;2019-01-02 13:00:08&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;99&#x27;</span>,<span class="number">100400</span>,<span class="string">&#x27;2019-01-02 13:00:09&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;12&#x27;</span>,<span class="number">100030</span>,<span class="string">&#x27;2019-01-02 13:00:10&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;13&#x27;</span>,<span class="number">100003</span>,<span class="string">&#x27;2019-01-02 13:00:20&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;14&#x27;</span>,<span class="number">100020</span>,<span class="string">&#x27;2019-01-02 13:00:30&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;15&#x27;</span>,<span class="number">100500</span>,<span class="string">&#x27;2019-01-02 13:00:40&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;16&#x27;</span>,<span class="number">106000</span>,<span class="string">&#x27;2019-01-02 13:00:50&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;17&#x27;</span>,<span class="number">100800</span>,<span class="string">&#x27;2019-01-02 13:00:59&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="number">100800</span>,<span class="string">&#x27;2019-01-02 13:00:11&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="number">100030</span>,<span class="string">&#x27;2019-01-02 13:00:12&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;10&#x27;</span>,<span class="number">100000</span>,<span class="string">&#x27;2019-01-02 13:00:13&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;45&#x27;</span>,<span class="number">100010</span>,<span class="string">&#x27;2019-01-02 13:00:14&#x27;</span>)</span><br><span class="line">,(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;78&#x27;</span>,<span class="number">100070</span>,<span class="string">&#x27;2019-01-02 13:00:15&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>查询SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        dist_id,</span><br><span class="line">        account,</span><br><span class="line">        <span class="built_in">sum</span>(money) <span class="keyword">as</span> sum_m</span><br><span class="line">    <span class="keyword">from</span> prac.test9</span><br><span class="line">    <span class="keyword">where</span> date_format(create_time,<span class="string">&#x27;yyyy-MM-dd&#x27;</span>)<span class="operator">=</span><span class="string">&#x27;2019-01-02&#x27;</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        dist_id,</span><br><span class="line">        account</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    t2.dist_id,</span><br><span class="line">    t2.account,</span><br><span class="line">    t2.sum_m,</span><br><span class="line">    <span class="string">&#x27;2019-01-02&#x27;</span></span><br><span class="line"><span class="keyword">from</span>(</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            t1.dist_id,</span><br><span class="line">            t1.account,</span><br><span class="line">            t1.sum_m,</span><br><span class="line">            <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> t1.dist_id <span class="keyword">order</span> <span class="keyword">by</span> sum_m <span class="keyword">desc</span>) <span class="keyword">as</span> rk</span><br><span class="line">        <span class="keyword">from</span> t1</span><br><span class="line">    ) <span class="keyword">as</span> t2</span><br><span class="line"><span class="keyword">where</span> rk<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test10(</span><br><span class="line">    `dist_id` string COMMENT <span class="string">&#x27;区组id&#x27;</span>,</span><br><span class="line">    `account` string COMMENT <span class="string">&#x27;账号&#x27;</span>,</span><br><span class="line">    `gold` <span class="type">int</span> COMMENT <span class="string">&#x27;金币&#x27;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h2 id="第十题："><a href="#第十题：" class="headerlink" title="第十题："></a>第十题：</h2><p>需求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">有一个账号表如下，请写出SQL语句，查询各自区组的money排名前十的账号（分组取前10）</span><br><span class="line">dist_id string  &#x27;区组id&#x27;,</span><br><span class="line">account string  &#x27;账号&#x27;,</span><br><span class="line">gold     int    &#x27;金币&#x27;  </span><br></pre></td></tr></table></figure>
<p>数据准备：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test10 <span class="keyword">VALUES</span> </span><br><span class="line"> (<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;77&#x27;</span>,<span class="number">18</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;88&#x27;</span>,<span class="number">106</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;99&#x27;</span>,<span class="number">10</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;12&#x27;</span>,<span class="number">13</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;13&#x27;</span>,<span class="number">14</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;14&#x27;</span>,<span class="number">25</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;15&#x27;</span>,<span class="number">36</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;16&#x27;</span>,<span class="number">12</span>)</span><br><span class="line">,(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;17&#x27;</span>,<span class="number">158</span>)</span><br><span class="line">,(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="number">12</span>)</span><br><span class="line">,(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="number">44</span>)</span><br><span class="line">,(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;10&#x27;</span>,<span class="number">66</span>)</span><br><span class="line">,(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;45&#x27;</span>,<span class="number">80</span>)</span><br><span class="line">,(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;78&#x27;</span>,<span class="number">98</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test10;</span><br></pre></td></tr></table></figure>
<p>查询SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询各自区组的money排名前十的账号（分组取前10）</span></span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        dist_id,</span><br><span class="line">        account,</span><br><span class="line">        gold,</span><br><span class="line">        <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> dist_id <span class="keyword">order</span> <span class="keyword">by</span> gold <span class="keyword">desc</span>) <span class="keyword">as</span> rk</span><br><span class="line">    <span class="keyword">from</span> prac.test10</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    t1.dist_id,</span><br><span class="line">    t1.account,</span><br><span class="line">    t1.gold,</span><br><span class="line">    t1.rk</span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">where</span> rk<span class="operator">&lt;=</span><span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p>这10道题并不难，和工作中的HiveSQL相比真的不算什么了，日拱一卒。加油！</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/cn/5acd.html" rel="prev" title="一道有意思的SQL">
                  <i class="fa fa-chevron-left"></i> 一道有意思的SQL
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/cn/2c3f.html" rel="next" title="PostgreSql学习">
                  PostgreSql学习 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline-comments"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Pan</span>
</div>

    </div>
  </footer>

  
  <script src="/cn/js/anime.min.js"></script>
<script src="/cn/js/comments.js"></script><script src="/cn/js/utils.js"></script><script src="/cn/js/motion.js"></script><script src="/cn/js/schemes/muse.js"></script><script src="/cn/js/next-boot.js"></script>

  
<script src="/cn/js/search.js"></script>
<script src="/cn/js/third-party/search/local-search.js"></script>





  




<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://comment.mapan.tech","placeholder":"说点什么吧...","avatar":"mp","pageSize":10,"visitor":true,"comment_count":false,"requiredFields":["nick","mail"],"meta":["nick","mail","link"],"libUrl":"/js/Waline.min/js","copyright":false,"el":"#waline-comments","path":"/cn/f9fb.html"}</script>
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() => 
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => {
    new Waline(CONFIG.waline);
  });
});
</script>
</body>
</html>
